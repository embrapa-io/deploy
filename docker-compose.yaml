version: '3.9'

services:
  daemon:
    build:
      context: .
      dockerfile: ./docker/daemon/Dockerfile
      args:
        DEBUG: ${DEBUG}
        SCHEDULER_MINUTES: ${SCHEDULER_MINUTES}
    restart: unless-stopped
    privileged: true
    environment:
      - SERVER
      - ORCHESTRATOR
      - GITLAB_URL
      - GITLAB_SSH
      - GITLAB_TOKEN
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_SECURE
      - LOG_MAIL
      - LOCK_LIFETIME_MINUTES
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - .:/app
      - /app/vendor
    healthcheck:
      test: php -l /app/releaser.php || exit 1
      interval: 10s
      timeout: 10s
      start_period: 5s
      retries: 5

  mail:
    build:
      dockerfile: ./docker/mail/Dockerfile
    restart: unless-stopped
    user: root
    expose:
      - 1025
      - 8025
    ports:
      - ${MAILHOG_PORT}:8025
    profiles:
      - development
